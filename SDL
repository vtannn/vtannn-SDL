#include<iostream>
#include<SDL.h>
#include<SDL_image.h>
#include "defs.h"
#include "graphics.h"
#include "logic.h"
using namespace std;
void waitUntilKeypressed()
{
    SDL_Event e;
    while(true)
    {
        if(SDL_PollEvent(&e)!=0&&
           (e.type==SDL_KEYDOWN||e.type==SDL_QUIT)) return;
        SDL_Delay(100);
    }
}
int main(int argc,char* args[])
{
    Graphics graphics;
    graphics.init();

    SDL_Texture *background=graphics.loadTexture("fbimg/bg.PNG");
    ScrollingBackground bgr;
    bgr.setTexture(background);

    ScrollingBackground ground;
    ground.setTexture(graphics.loadTexture("fbimg/ground.PNG"));

    Mouse mouse;

    Sprite bird;
    bird.clips.push_back(graphics.bird1);
    bird.clips.push_back(graphics.bird2);
    bird.clips.push_back(graphics.bird3);

    SDL_Event e;
    int x,y;
    while(!quit)
    {
        //jump
        if(SDL_PollEvent(&e))
        {
            if(e.type==SDL_QUIT) quit=true;
            if(e.type==SDL_KEYDOWN)
            {
                if(!flying) flying=true;
                mouse.speed=-25;
                mouse.check=false;
            }
            else mouse.check=true;
        }
        if(mouse.y==620) game_over=true;
        if(!game_over)
        {
            //gravity
            if(flying)
            {
                mouse.speed+=5;
                mouse.speed=min(mouse.speed,10);
                mouse.turnSouth();
                mouse.move();
                mouse.y=min(mouse.y,620);
            }
            //scroll
            bgr.scroll(5);
            ground.scroll(5);
            bird.tick();
            //render
            SDL_RenderClear(graphics.renderer);
            graphics.renderBackground(bgr,0);
            graphics.renderBackground(ground,620);
            graphics.renderBIRD(mouse.x,mouse.y-36,bird,mouse.speed);
        }
        else
        {
            SDL_RenderClear(graphics.renderer);
            graphics.renderBackground(bgr,0);
            graphics.renderBackground(ground,620);
            graphics.renderBIRD(mouse.x,mouse.y-36,bird,90);
        }
        graphics.presentRenderer();
        SDL_Delay(40);
    }
    SDL_DestroyTexture(graphics.bird1);
    SDL_DestroyTexture(background);

    waitUntilKeypressed();
    graphics.QUIT();
}
